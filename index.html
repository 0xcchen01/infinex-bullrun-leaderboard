<!DOCTYPE html>
<html lang="zh-CN"
>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infinex Bullrun æ’è¡Œæ¦œæŸ¥è¯¢</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .social-links {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .social-links a {
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            font-size: 16px;
        }

        .social-links a:hover {
            color: white;
            transform: translateY(-2px);
        }

        .social-links i {
            font-size: 20px;
        }

        .header .stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 5px;
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .search-box {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 12px 20px;
            font-size: 16px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .page-size-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .page-size-label {
            font-weight: 600;
            color: #495057;
            white-space: nowrap;
        }

        .page-size-select {
            padding: 10px 15px;
            font-size: 14px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .page-size-select:hover {
            border-color: #667eea;
        }

        .page-size-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .table-container {
            overflow-x: auto;
            padding: 0 30px 30px 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        thead {
            background: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            cursor: pointer;
            user-select: none;
            transition: background 0.3s;
        }

        th:hover {
            background: #e9ecef;
        }

        th.sortable::after {
            content: ' â‡…';
            opacity: 0.3;
        }

        th.sorted-asc::after {
            content: ' â–²';
            opacity: 1;
        }

        th.sorted-desc::after {
            content: ' â–¼';
            opacity: 1;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        tbody tr {
            transition: background 0.3s;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .rank {
            font-weight: 700;
            color: #667eea;
            font-size: 1.1em;
        }

        .rank-1 {
            color: #FFD700;
        }

        .rank-2 {
            color: #C0C0C0;
        }

        .rank-3 {
            color: #CD7F32;
        }

        .username {
            font-weight: 600;
            color: #212529;
        }

        .user-id {
            font-family: monospace;
            color: #6c757d;
            font-size: 0.85em;
        }

        .points {
            font-weight: 600;
            color: #28a745;
        }

        .bulls {
            font-weight: 600;
            color: #fd7e14;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
            font-size: 1.2em;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            font-size: 1.2em;
            color: #667eea;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 20px;
            flex-wrap: wrap;
        }

        .page-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .page-btn:hover:not(:disabled) {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .page-info {
            color: #6c757d;
            font-size: 14px;
        }

        /* æ•°æ®åˆ†ææŠ˜å æ ·å¼ */
        .analytics-section {
            padding: 0 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
            overflow: hidden;
            max-height: 0;
        }

        .analytics-section.expanded {
            max-height: 2000px;
            padding: 30px;
        }

        .analytics-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px 30px;
            background: #f1f3f5;
            cursor: pointer;
            border-bottom: 2px solid #e9ecef;
            color: #495057;
            font-weight: 600;
            font-size: 1.2em;
            transition: background 0.3s;
        }

        .analytics-toggle:hover {
            background: #e9ecef;
        }

        .analytics-toggle i {
            margin-left: 10px;
            transition: transform 0.3s;
        }

        .analytics-toggle.active i {
            transform: rotate(180deg);
        }

        /* å¤šå›¾è¡¨å®¹å™¨æ ·å¼ */
        .charts-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px;
        }

        .chart-item {
            flex: 1 1 300px;
            min-width: 300px;
            max-width: 400px;
            text-align: center;
        }

        .chart-title {
            font-size: 1.2em;
            color: #495057;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .chart-container {
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .stat-value {
                font-size: 1.5em;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 10px 8px;
            }

            .chart-item {
                max-width: 100%;
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ğŸ† Infinex Bullrun æ’è¡Œæ¦œ</h1>
        <div class="social-links">
            <a href="https://github.com/0xcchen01" target="_blank" rel="noopener noreferrer">
                <i class="fab fa-github"></i>
                <span>Github</span>
            </a>
            <a href="https://x.com/0xcchen01" target="_blank" rel="noopener noreferrer">
                <i class="fab fa-twitter"></i>
                <span>Twitter</span>
            </a>
        </div>
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="totalUsers">-</div>
                <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="generatedAt">-</div>
                <div class="stat-label">æ›´æ–°æ—¶é—´</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="displayedUsers">-</div>
                <div class="stat-label">æ˜¾ç¤ºç”¨æˆ·æ•°</div>
            </div>
        </div>
    </div>

    <div id="analyticsToggle" class="analytics-toggle">
        <span>ğŸ“Š æ•°æ®åˆ†æ (ç‚¹å‡»å±•å¼€/æŠ˜å )</span>
        <i class="fas fa-chevron-down"></i>
    </div>

    <div id="analyticsSection" class="analytics-section">
        <div class="charts-grid">
            <div class="chart-item">
                <h2 class="chart-title">ğŸ¯ å›åˆæ•°åˆ†å¸ƒ</h2>
                <div class="chart-container">
                    <canvas id="roundsChart"></canvas>
                </div>
            </div>
            <div class="chart-item">
                <h2 class="chart-title">ğŸ“ˆ æ€»ç§¯åˆ†åˆ†å¸ƒ</h2>
                <div class="chart-container">
                    <canvas id="pointsChart"></canvas>
                </div>
            </div>
            <div class="chart-item">
                <h2 class="chart-title">ğŸ‚ æ€» Bulls åˆ†å¸ƒ</h2>
                <div class="chart-container">
                    <canvas id="bullsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="controls">
        <div class="search-box">
            <input
                    type="text"
                    id="searchInput"
                    class="search-input"
                    placeholder="ğŸ” æœç´¢ç”¨æˆ·åæˆ–ç”¨æˆ·ID (æ”¯æŒ 'user1 | user2' å¤šè¯æ¨¡ç³Šæœç´¢)"
            >

            <div class="page-size-control">
                <label for="minRoundsInput" class="page-size-label">å›åˆæ•°:</label>
                <input
                        type="number"
                        id="minRoundsInput"
                        class="page-size-select"
                        placeholder="æœ€å°"
                        min="0"
                        style="width: 80px;"
                >
                <span class="page-size-label" style="font-weight: normal;">è‡³</span>
                <input
                        type="number"
                        id="maxRoundsInput"
                        class="page-size-select"
                        placeholder="æœ€å¤§"
                        min="0"
                        style="width: 80px;"
                >
            </div>
            <div class="page-size-control">
                <label for="pageSizeSelect" class="page-size-label">æ¯é¡µæ˜¾ç¤ºï¼š</label>
                <select id="pageSizeSelect" class="page-size-select">
                    <option value="20">20</option>
                    <option value="50" selected>50</option>
                    <option value="100">100</option>
                    <option value="200">200</option>
                    <option value="500">500</option>
                </select>
            </div>
        </div>
    </div>

    <div class="table-container">
        <div id="loading" class="loading">åŠ è½½æ•°æ®ä¸­...</div>
<table id="rankingsTable" style="display: none;">
    <thead>
    <tr>
        <th class="sortable" data-sort="rank">æ’å</th>
        <th class="sortable" data-sort="username">ç”¨æˆ·å</th>
        <th class="sortable" data-sort="total_points">æ€»ç§¯åˆ†</th>
        <th class="sortable" data-sort="total_bulls">æ€»Bulls</th>
        <th class="sortable" data-sort="rounds_participated">å›åˆæ•°</th>
        <th>ç”¨æˆ·ID</th>
    </tr>
    </thead>
    <tbody id="tableBody">
    </tbody>
</table>
        <div id="noResults" class="no-results" style="display: none;">
            æœªæ‰¾åˆ°åŒ¹é…çš„ç”¨æˆ· ğŸ˜¢
        </div>
    </div>

    <div class="pagination" id="pagination" style="display: none;"></div>
</div>


<script>
    // âš ï¸ ç»ˆæå‹ç¼©åçš„å­—æ®µåæ˜ å°„è¡¨
    const FIELD_MAP = {
        // é¡¶å±‚å­—æ®µ
        total_users: "t",
        generated_at: "g",
        rankings: "R",

        // æ’è¡Œæ¦œç”¨æˆ·åˆ—è¡¨ä¸­çš„å­—æ®µ
        userId: "i",
        username: "n",
        total_points: "p",
        total_bulls: "b",
        rounds_participated: "r",
        avg_points: "a",
    };

    // âš ï¸ å®šä¹‰ä¸€ä¸ªåå‘æ˜ å°„è¡¨ï¼Œç”¨äºå°† HTML ä¸­çš„åŸå§‹å­—æ®µåæ˜ å°„åˆ° JSON ä¸­çš„ç¼©å†™é”®
    const INVERSE_FIELD_MAP = {
        "username": FIELD_MAP.username, // 'n'
        "total_points": FIELD_MAP.total_points, // 'p'
        "total_bulls": FIELD_MAP.total_bulls, // 'b'
        "rounds_participated": FIELD_MAP.rounds_participated, // 'r'
        "userId": FIELD_MAP.userId, // 'i'
        "rank": 'current_rank' // rank å­—æ®µæ˜¯ JS å†…éƒ¨è®¡ç®—çš„
    };


    let allData = [];
    let filteredData = [];

    // âš ï¸ é»˜è®¤æ’åºå­—æ®µåº”ä½¿ç”¨ JSON å†…éƒ¨çš„ç¼©å†™é”®ï¼Œæˆ–è€…ä½¿ç”¨ rankï¼Œè¿™é‡Œä½¿ç”¨ Bulls çš„ç¼©å†™é”® 'b'
    let currentSort = {field: INVERSE_FIELD_MAP.total_bulls, order: 'desc'};

    let currentPage = 1;
    let itemsPerPage = 50;
    let chartInstance = null;
    let pointsChartInstance = null;
    let bullsChartInstance = null;

    // ä¿®å¤ï¼šæ’åºç‚¹å‡»å¤„ç†å‡½æ•°
    function handleSortClick() {
        // ğŸš¨ å…³é”®ä¿®å¤ï¼šå°† HTML çš„ data-sort å±æ€§ (ä¾‹å¦‚ "total_points")
        // æ˜ å°„ä¸º JSON å†…éƒ¨çš„ç¼©å†™é”® (ä¾‹å¦‚ "p")
        const htmlField = this.dataset.sort;
        const jsonField = INVERSE_FIELD_MAP[htmlField] || htmlField; // æ‰¾ä¸åˆ°æ˜ å°„çš„ä¿æŒåŸæ ·ï¼ˆå¦‚ current_rankï¼‰
        sortData(jsonField);
    }


    // ===================================
    // æ ¸å¿ƒæ•°æ®åŠ è½½ä¸åˆå§‹åŒ–
    // ===================================
    async function loadData() {
        try {
            // ç¡®ä¿æ•°æ®æ–‡ä»¶è·¯å¾„æ­£ç¡®
            const response = await fetch('/user_rankings_simplified.json');
            const data = await response.json();

            // âš ï¸ è¯»å–ç¼©å†™åçš„é¡¶å±‚å­—æ®µ
            const rankings = data[FIELD_MAP.rankings] || [];
            const totalUsers = data[FIELD_MAP.total_users];
            const generatedAt = data[FIELD_MAP.generated_at];

            // æ·»åŠ æ’å
            allData = rankings.map((user, index) => ({
                ...user,
                rank: index + 1,
                current_rank: index + 1
            }));

            // âš ï¸ è®¡ç®—å¹¶ä¿å­˜Bullsæ’å (ä½¿ç”¨ç¼©å†™é”® 'b')
            const bullsSorted = [...allData].sort((a, b) => b[FIELD_MAP.total_bulls] - a[FIELD_MAP.total_bulls]);
            bullsSorted.forEach((user, index) => {
                user.bulls_rank = index + 1;
            });

            // åˆå§‹åŒ–æ•°æ®
            applyFiltersAndSort();

            // âš ï¸ æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ (ä½¿ç”¨ç¼©å†™é”®)
            document.getElementById('totalUsers').textContent = totalUsers.toLocaleString();
            document.getElementById('generatedAt').textContent = generatedAt;
            document.getElementById('displayedUsers').textContent = allData.length.toLocaleString();

            document.getElementById('loading').style.display = 'none';
            document.getElementById('rankingsTable').style.display = 'table';

            // ğŸš¨ ä¿®å¤ï¼šé‡æ–°ç»‘å®šæ’åºäº‹ä»¶åˆ° th å…ƒç´ ä¸Šã€‚
            // ä¿æŒ HTML ä¸­çš„ data-sort å­—æ®µåä¸å˜ (å¦‚ "total_points")ï¼Œ
            // ç„¶åä½¿ç”¨ handleSortClick è¿›è¡Œæ˜ å°„ã€‚
            document.querySelectorAll('th.sortable').forEach(th => {
                th.removeEventListener('click', handleSortClick); // é¿å…é‡å¤ç»‘å®š
                th.addEventListener('click', handleSortClick);
            });

            // ç»‘å®šåˆ†æåˆ‡æ¢äº‹ä»¶
            document.getElementById('analyticsToggle').addEventListener('click', toggleAnalytics);

            // æ¸²æŸ“é»˜è®¤æ’åºçŠ¶æ€
            updateSortHeaders();


        } catch (error) {
            console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
            document.getElementById('loading').innerHTML = 'âŒ åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®æºè·¯å¾„å’Œæ ¼å¼';
        }
    }

    // ===================================
    // æ•´åˆç­›é€‰å’Œæ’åºé€»è¾‘
    // ===================================
    function applyFiltersAndSort() {
        const searchQuery = document.getElementById('searchInput').value.toLowerCase().trim();
        const minRounds = parseInt(document.getElementById('minRoundsInput').value) || 0;
        const maxRounds = parseInt(document.getElementById('maxRoundsInput').value) || Infinity;

        // 1. ç­›é€‰æ•°æ®
        let tempFilteredData = allData.filter(user => {
            // âš ï¸ å›åˆæ•°ç­›é€‰ (ä½¿ç”¨ç¼©å†™é”® 'r')
            const rounds = user[FIELD_MAP.rounds_participated];
            const roundsFilter = rounds >= minRounds && rounds <= maxRounds;

            // æœç´¢å…³é”®è¯ç­›é€‰ (ä½¿ç”¨ç¼©å†™é”® 'n' å’Œ 'i')
            let searchFilter = true;
            if (searchQuery) {
                const searchTerms = searchQuery.split(/\s*\|\s*|\s+/).filter(term => term.length > 0);
                const username = (user[FIELD_MAP.username] || '').toLowerCase();
                const userId = (user[FIELD_MAP.userId] || '').toLowerCase();
                searchFilter = searchTerms.some(term =>
                    username.includes(term) || userId.includes(term)
                );
            }

            return roundsFilter && searchFilter;
        });

        // 2. æ’åºæ•°æ®
        const {field, order} = currentSort;

        tempFilteredData.sort((a, b) => {
            // âš ï¸ æ’åºå­—æ®µä½¿ç”¨ç¼©å†™é”®æˆ– 'current_rank'
            let aVal = a[field];
            let bVal = b[field];

            // å¤„ç† current_rank å­—æ®µ (æ•°å­—)
            if (field === 'current_rank') {
                 // æ’åé€šå¸¸æ˜¯å‡åº (1, 2, 3...)
                 if (order === 'asc') return aVal - bVal;
                 else return bVal - aVal;
            }

            // å¤„ç†éæ’åå­—æ®µ
            if (typeof aVal === 'string') {
                aVal = aVal.toLowerCase();
                bVal = bVal.toLowerCase();
            }

            // æ•°å€¼å‹/å­—ç¬¦ä¸²å‹å­—æ®µçš„é™åº/å‡åºå¤„ç†
            if (order === 'asc') {
                return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
            } else {
                return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
            }
        });

        // 3. æ›´æ–°å½“å‰æ’å
        tempFilteredData.forEach((user, index) => {
            user.current_rank = index + 1;
        });

        filteredData = tempFilteredData;
        currentPage = 1;
        renderTable();
    }

    function sortData(field, order = null) {
        if (order === null) {
            if (currentSort.field === field) {
                order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                // âš ï¸ ä½¿ç”¨ç¼©å†™é”®åˆ¤æ–­é»˜è®¤æ’åºæ–¹å‘
                const descFields = [FIELD_MAP.total_bulls, FIELD_MAP.total_points];
                order = descFields.includes(field) ? 'desc' : 'asc';
            }
        }

        currentSort = {field, order};
        updateSortHeaders();
        applyFiltersAndSort(); // æ’åºåé‡æ–°åº”ç”¨ç­›é€‰å’Œæ¸²æŸ“
    }

    function updateSortHeaders() {
        document.querySelectorAll('th.sortable').forEach(th => {
            th.classList.remove('sorted-asc', 'sorted-desc');

            const htmlField = th.dataset.sort;
            const jsonField = INVERSE_FIELD_MAP[htmlField] || htmlField;

            if (jsonField === currentSort.field) {
                th.classList.add(`sorted-${currentSort.order}`);
            }
        });
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        const noResults = document.getElementById('noResults');
        const pagination = document.getElementById('pagination');

        if (filteredData.length === 0) {
            tbody.innerHTML = '';
            noResults.style.display = 'block';
            pagination.style.display = 'none';
            return;
        }

        noResults.style.display = 'none';

        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageData = filteredData.slice(startIndex, endIndex);

        tbody.innerHTML = pageData.map(user => {
            let displayRank = user.current_rank;

            let rankClass = '';
            if (displayRank === 1) rankClass = 'rank-1';
            else if (displayRank === 2) rankClass = 'rank-2';
            else if (displayRank === 3) rankClass = 'rank-3';

            return `
                    <tr>
                        <td class="rank ${rankClass}">#${displayRank}</td>
                        <td class="username">${user[FIELD_MAP.username]}</td>
                        <td class="points">${user[FIELD_MAP.total_points].toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
                        <td class="bulls">${user[FIELD_MAP.total_bulls].toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
                        <td>${user[FIELD_MAP.rounds_participated]}</td>
                        <td class="user-id">${user[FIELD_MAP.userId]}</td>
                    </tr>
                `;
        }).join('');

        renderPagination();
    }

    function renderPagination() {
        const pagination = document.getElementById('pagination');
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);

        if (totalPages <= 1) {
            pagination.style.display = 'none';
            return;
        }

        pagination.style.display = 'flex';

        let paginationHTML = `
                <button class="page-btn" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                    â† ä¸Šä¸€é¡µ
                </button>
                <span class="page-info">ç¬¬ ${currentPage} / ${totalPages} é¡µ (å…± ${filteredData.length} æ¡ï¼Œæ¯é¡µ ${itemsPerPage} æ¡)</span>
                <button class="page-btn" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                    ä¸‹ä¸€é¡µ â†’
                </button>
            `;

        pagination.innerHTML = paginationHTML;
    }

    function changePage(page) {
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        renderTable();
        document.querySelector('.table-container').scrollIntoView({behavior: 'smooth'});
    }

    // --- å›¾è¡¨ç›¸å…³å‡½æ•°ï¼ˆä¿®å¤æ•°æ®å¼•ç”¨ï¼‰---
    function toggleAnalytics() {
        const section = document.getElementById('analyticsSection');
        const toggleBtn = document.getElementById('analyticsToggle');

        // ğŸš¨ ä¿®å¤æ•°æ®åˆ†æç‚¹ä¸å¼€çš„é—®é¢˜ï¼šç¡®ä¿äº‹ä»¶ç»‘å®šæˆåŠŸ
        // è¿™éƒ¨åˆ†é€»è¾‘æœ¬èº«æ˜¯æ­£ç¡®çš„ï¼Œé—®é¢˜å¯èƒ½æ˜¯å› ä¸º loadData å¤±è´¥æˆ– HTML ç»“æ„é—®é¢˜ã€‚
        // ä½†è¿™é‡Œåªéœ€ç¡®ä¿ loadData ä¸­äº‹ä»¶ç»‘å®šæ˜¯æ­£ç¡®çš„å³å¯ã€‚
        section.classList.toggle('expanded');
        toggleBtn.classList.toggle('active');

        if (section.classList.contains('expanded')) {
            // å»¶è¿Ÿåˆ›å»ºå›¾è¡¨ï¼Œç¡®ä¿ DOM å·²ç»å±•å¼€å¹¶æœ‰å°ºå¯¸
            setTimeout(() => {
                if (!chartInstance) createRoundsChart();
                if (!pointsChartInstance) createPointsChart();
                if (!bullsChartInstance) createBullsChart();
            }, 100);
        }
    }

    function createRoundsChart() {
        const bins = [
            {label: 'ä½äº 10', max: 9, count: 0, color: '#4CAF50'},
            {label: '10 - 49', min: 10, max: 49, count: 0, color: '#2196F3'},
            {label: '50 - 99', min: 50, max: 99, count: 0, color: '#FFC107'},
            {label: '100 - 199', min: 100, max: 199, count: 0, color: '#FF5722'},
            {label: '200+', min: 200, count: 0, color: '#9C27B0'}
        ];

        // âš ï¸ ä½¿ç”¨ç¼©å†™é”® 'r'
        allData.forEach(user => {
            const rounds = user[FIELD_MAP.rounds_participated];
            for (const bin of bins) {
                if (bin.max !== undefined && rounds <= bin.max && (bin.min === undefined || rounds >= bin.min)) {
                    bin.count++;
                    break;
                } else if (bin.min !== undefined && rounds >= bin.min && bin.max === undefined) {
                    bin.count++;
                    break;
                }
            }
        });

        const labels = bins.map(b => b.label);
        const data = bins.map(b => b.count);
        const backgroundColors = bins.map(b => b.color);
        const totalUsers = allData.length;
        const percentages = data.map(count => ((count / totalUsers) * 100).toFixed(1));

        const ctx = document.getElementById('roundsChart').getContext('2d');

        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    label: 'ç”¨æˆ·æ•°',
                    data: data,
                    backgroundColor: backgroundColors,
                    borderColor: 'white',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    title: {display: false},
                    legend: {position: 'bottom'},
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const percentage = percentages[context.dataIndex];
                                return `${label}: ${value} äºº (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    function createPointsChart() {
        // âš ï¸ ä½¿ç”¨ç¼©å†™é”® 'p'
        const points = allData.map(user => user[FIELD_MAP.total_points]).filter(p => !isNaN(p));
        const ctx = document.getElementById('pointsChart').getContext('2d');

        if (pointsChartInstance) pointsChartInstance.destroy();
        if (points.length === 0) {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            return;
        }
        const bins = [
            {label: 'è´Ÿç§¯åˆ†', min: -Infinity, max: -0.01, count: 0, color: '#A0A0A0'}, // è´Ÿåˆ†
            {label: '0 - 4,999', min: 0, max: 4999, count: 0, color: '#A0D911'},         // ä½æ´»è·ƒ
            {label: '5,000 - 9,999', min: 5000, max: 9999, count: 0, color: '#52C41A'},     // ä¸­ä½
            {label: '10,000 - 29,999', min: 10000, max: 29999, count: 0, color: '#1890FF'}, // ä¸­é«˜
            {label: '30,000 - 49,999', min: 30000, max: 49999, count: 0, color: '#FAAD14'}, // è¾ƒé«˜
            {label: '50,000 - 99,999', min: 50000, max: 99999, count: 0, color: '#FF7A45'}, // é«˜æ´»è·ƒ
            {label: '100,000+', min: 100000, max: Infinity, count: 0, color: '#F5222D'},   // æé«˜
        ];

        points.forEach(p => {
            for (const bin of bins) {
                if (p >= bin.min && (p <= bin.max || (bin.max === Infinity && p >= bin.min))) {
                    bin.count++;
                    break;
                }
            }
        });

        const totalUsers = allData.length;
        const labels = bins.map(b => b.label);
        const data = bins.map(b => b.count);
        const backgroundColors = bins.map(b => b.color);
        const percentages = data.map(count => totalUsers > 0 ? ((count / totalUsers) * 100).toFixed(1) : '0.0');

        pointsChartInstance = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    label: 'ç”¨æˆ·æ•°',
                    data: data,
                    backgroundColor: backgroundColors,
                    borderColor: 'white',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    title: {display: false},
                    legend: {position: 'bottom'},
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const percentage = percentages[context.dataIndex];
                                return `${label}: ${value} äºº (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    function createBullsChart() {
        // âš ï¸ ä½¿ç”¨ç¼©å†™é”® 'b'
        const bulls = allData.map(user => user[FIELD_MAP.total_bulls]).filter(b => b >= 0 && !isNaN(b));
        const ctx = document.getElementById('bullsChart').getContext('2d');

        if (bullsChartInstance) bullsChartInstance.destroy();
        if (bulls.length === 0) {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            return;
        }
        const bins = [
            {label: '0 - 0.99 Bulls', min: 0, max: 0.99, count: 0, color: '#C0C0C0'},
            {label: '1 - 999 Bulls', min: 1, max: 999, count: 0, color: '#FADB14'},
            {label: '1,000 - 2,999', min: 1000, max: 2999, count: 0, color: '#FAAD14'},
            {label: '3,000 - 4,999', min: 3000, max: 4999, count: 0, color: '#FFC53D'},
            {label: '5,000 - 9,999', min: 5000, max: 9999, count: 0, color: '#FF7A45'},
            {label: '10,000 - 29,999', min: 10000, max: 29999, count: 0, color: '#FF4D4F'},
            {label: '30,000 - 49,999', min: 30000, max: 49999, count: 0, color: '#EB2F96'},
            {label: '50,000 - 99,999', min: 50000, max: 99999, count: 0, color: '#722ED1'},
            {label: '100,000+', min: 100000, max: Infinity, count: 0, color: '#2F54EB'},
        ];

        bulls.forEach(b => {
            for (const bin of bins) {
                if (b >= bin.min && (b <= bin.max || (bin.max === Infinity && b >= bin.min))) {
                    bin.count++;
                    break;
                }
            }
        });

        const totalUsers = allData.length;
        const labels = bins.map(b => b.label);
        const data = bins.map(b => b.count);
        const backgroundColors = bins.map(b => b.color);
        const percentages = data.map(count => totalUsers > 0 ? ((count / totalUsers) * 100).toFixed(1) : '0.0');
        bullsChartInstance = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    label: 'ç”¨æˆ·æ•°',
                    data: data,
                    backgroundColor: backgroundColors,
                    borderColor: 'white',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    title: {display: false},
                    legend: {position: 'bottom'},
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const percentage = percentages[context.dataIndex];
                                return `${label}: ${value} äºº (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // ===================================
    // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
    // ===================================
    document.getElementById('searchInput').addEventListener('input', applyFiltersAndSort);
    document.getElementById('minRoundsInput').addEventListener('input', applyFiltersAndSort);
    document.getElementById('maxRoundsInput').addEventListener('input', applyFiltersAndSort);

    document.getElementById('pageSizeSelect').addEventListener('change', (e) => {
        itemsPerPage = parseInt(e.target.value);
        currentPage = 1;
        renderTable();
    });

    // æ’åºäº‹ä»¶çš„ç»‘å®šå·²ç§»è‡³ loadData å‡½æ•°ä¸­

    loadData();
</script>
</body>

</html>
